name: Daily Push and Create Python File

on:
  schedule:
    # Chạy 2 lần mỗi ngày với thời gian ngẫu nhiên dựa trên ngày
    # Sử dụng modulo để tạo 2 khung giờ khác nhau mỗi ngày
    - cron: "0 8,20 * * *" # Chạy lúc 8:00 và 20:00 UTC (15:00 và 3:00 sáng VN)
  workflow_dispatch: # Cho phép trigger thủ công từ GitHub UI

jobs:
  push_and_create_file:
    name: Push to GitHub and Create Python File
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Create logging directory
        run: |
          mkdir -p ./logging
          echo "Logging directory created/verified"

      - name: Run Bash script
        run: |
          mkdir -p ./logging
          echo "Logging directory verified: $(ls -d ./logging 2>/dev/null && echo 'exists' || echo 'created')"

          git config --global user.email "minhthanh95ptit@gmail.com"
          git config --global user.name "Minh Thanh Pham"

          # Sử dụng ngày hiện tại làm seed để đảm bảo cùng một ngày sẽ có cùng số commit
          DATE_SEED=$(date +'%Y-%m-%d')
          DAY_NUMBER=$(date +%j)
          CURRENT_HOUR=$(date +%H)

          # Tạo số ngẫu nhiên dựa trên ngày (0-999)
          RANDOM_NUM=$(( (DAY_NUMBER * 17 + 23) % 1000 ))

          # Quyết định số lượng commit TỔNG cho ngày hôm nay (phân phối tự nhiên như developer thật)
          # 18% không commit (random), 22% 1-3 commits (ngày ít), 
          # 30% 4-8 commits (ngày bình thường), 20% 9-15 commits (ngày nhiều), 10% 16-25 commits (ngày rất nhiều)
          if [ $RANDOM_NUM -lt 180 ]; then
            # 18% - Không commit (random, không phụ thuộc vào thứ trong tuần)
            TOTAL_COMMITS=0
          elif [ $RANDOM_NUM -lt 400 ]; then
            # 22% - Ngày ít commit (1-3 commits)
            TOTAL_COMMITS=$(( 1 + (RANDOM_NUM % 3) ))
          elif [ $RANDOM_NUM -lt 700 ]; then
            # 30% - Ngày bình thường (4-8 commits)
            TOTAL_COMMITS=$(( 4 + (RANDOM_NUM % 5) ))
          elif [ $RANDOM_NUM -lt 900 ]; then
            # 20% - Ngày nhiều commit (9-15 commits)
            TOTAL_COMMITS=$(( 9 + (RANDOM_NUM % 7) ))
          else
            # 10% - Ngày rất nhiều commit (16-25 commits)
            TOTAL_COMMITS=$(( 16 + (RANDOM_NUM % 10) ))
          fi

          # Chia commit cho 2 lần chạy trong ngày (dựa trên giờ chạy)
          # Lần 1 (8h UTC): 40-60% commit, Lần 2 (20h UTC): phần còn lại
          if [ "$CURRENT_HOUR" = "08" ]; then
            # Lần chạy đầu tiên: 40-60% tổng số commit
            SPLIT_RATIO=$(( 40 + (DAY_NUMBER * 7) % 21 )) # 40-60%
            COMMIT_COUNT=$(( (TOTAL_COMMITS * SPLIT_RATIO) / 100 ))
            SESSION=1
          else
            # Lần chạy thứ hai: phần còn lại
            SPLIT_RATIO=$(( 40 + (DAY_NUMBER * 7) % 21 ))
            FIRST_SESSION=$(( (TOTAL_COMMITS * SPLIT_RATIO) / 100 ))
            COMMIT_COUNT=$(( TOTAL_COMMITS - FIRST_SESSION ))
            SESSION=2
          fi

          echo "Date: $DATE_SEED | Session: $SESSION | Total commits today: $TOTAL_COMMITS | This session: $COMMIT_COUNT"

          # Nếu không có commit nào cho session này, thoát
          if [ $COMMIT_COUNT -eq 0 ]; then
            echo "No commits scheduled for this session. Skipping..."
            exit 0
          fi

          # Tính offset commit để đánh số đúng (session 2 bắt đầu từ số tiếp theo)
          if [ "$SESSION" = "2" ]; then
            SPLIT_RATIO=$(( 40 + (DAY_NUMBER * 7) % 21 ))
            COMMIT_OFFSET=$(( (TOTAL_COMMITS * SPLIT_RATIO) / 100 ))
          else
            COMMIT_OFFSET=0
          fi

          # Tạo các commit với thời gian ngẫu nhiên trong ngày
          for i in $(seq 1 $COMMIT_COUNT); do
            COMMIT_NUMBER=$(( COMMIT_OFFSET + i ))
            # Tạo timestamp ngẫu nhiên trong ngày
            # Session 1: 8h-14h, Session 2: 14h-22h
            if [ "$SESSION" = "1" ]; then
              HOUR_OFFSET=$(( 8 + (DAY_NUMBER * 7 + COMMIT_NUMBER * 13) % 6 ))
            else
              HOUR_OFFSET=$(( 14 + (DAY_NUMBER * 11 + COMMIT_NUMBER * 17) % 8 ))
            fi
            MINUTE_OFFSET=$(( (DAY_NUMBER * 11 + COMMIT_NUMBER * 19) % 60 ))
            
            # Tạo tên file với timestamp trong thư mục logging
            file_name="./logging/$(date +'%Y-%m-%d')_commit_${COMMIT_NUMBER}_${HOUR_OFFSET}-${MINUTE_OFFSET}.py"
            
            # Tạo nội dung file với một số thay đổi ngẫu nhiên
            RANDOM_CODE=$(( (DAY_NUMBER * COMMIT_NUMBER * 3) % 1000 ))
            echo -e "# Auto-generated on $DATE_SEED\n# Commit $COMMIT_NUMBER of $TOTAL_COMMITS (Session $SESSION)\nprint('Hello from commit $COMMIT_NUMBER, value: $RANDOM_CODE')\nprint('Date: $DATE_SEED')" > "$file_name"
            
            # Commit với message đa dạng hơn
            COMMIT_MESSAGES=(
              "Update: $DATE_SEED commit $i"
              "Fix: minor changes on $DATE_SEED"
              "Refactor: code improvements"
              "Add: new feature implementation"
              "Update: documentation and comments"
              "Fix: bug fixes and optimizations"
              "Enhance: performance improvements"
              "Add: utility functions"
              "Update: configuration files"
              "Fix: edge case handling"
              "Refactor: clean up code structure"
              "Add: test cases"
              "Update: dependencies"
              "Fix: memory leaks"
              "Enhance: user experience"
              "Add: error handling"
              "Update: API endpoints"
              "Fix: security vulnerabilities"
              "Refactor: optimize algorithms"
              "Add: logging functionality"
            )
            MSG_INDEX=$(( (DAY_NUMBER * COMMIT_NUMBER) % ${#COMMIT_MESSAGES[@]} ))
            COMMIT_MSG="${COMMIT_MESSAGES[$MSG_INDEX]}"
            
            git add "$file_name"
            git commit -m "$COMMIT_MSG" --date="$DATE_SEED ${HOUR_OFFSET}:${MINUTE_OFFSET}:00"
            
            echo "Created commit $COMMIT_NUMBER/$TOTAL_COMMITS (Session $SESSION): $COMMIT_MSG"
          done

          # Push tất cả commits cùng lúc
          git push origin main
